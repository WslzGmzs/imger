<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imger - Fast, Free Image Hosting</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --pico-font-size: 100%;
        }
        body {
            padding: 1rem;
        }
        .container {
            max-width: 960px;
            margin: auto;
        }
        #drop-area {
            border: 2px dashed var(--pico-secondary-border);
            border-radius: var(--pico-border-radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: border-color 0.2s, background-color 0.2s;
        }
        #drop-area.highlight {
            border-color: var(--pico-primary);
            background-color: var(--pico-primary-background);
        }
        #fileElem {
            display: none;
        }
        #upload-button {
            width: 100%;
        }
        .thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--pico-border-radius);
            vertical-align: middle;
        }
        .filename {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }
        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin: 0.1rem;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            background-color: #333;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 30px;
        }
        table {
            table-layout: fixed;
            width: 100%;
        }
        td, th {
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <main class="container">
        <article>
            <hgroup>
                <h1>Imger</h1>
                <h2>Fast, free, login-free image hosting on the edge.</h2>
            </hgroup>

            <form id="uploadForm" enctype="multipart/form-data">
                <div id="drop-area">
                    <input type="file" id="fileElem" multiple accept="image/*,video/*">
                    <label for="fileElem" role="button" class="secondary outline">
                        Click to Select Files
                        <br>
                        <small>or Drag & Drop Here</small>
                    </label>
                </div>
                <progress id="progress-bar" style="display: none;"></progress>
                <div id="file-list-container" style="display: none;">
                    <h6>Files to Upload</h6>
                    <table id="file-list-table">
                        <tbody></tbody>
                    </table>
                </div>
                <button type="submit" id="upload-button" disabled>
                    <span role="status" id="upload-spinner" hidden></span>
                    Upload Files
                </button>
            </form>

            <div id="result-container" style="display: none;">
                <hr>
                <h3>Uploaded Images</h3>
                <div style="overflow-x: auto;">
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 80px;">Preview</th>
                                <th scope="col">Filename</th>
                                <th scope="col">URL</th>
                                <th scope="col" style="width: 200px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </article>
    </main>
    <div id="toast" class="toast" role="alert"></div>

<script>
    const dropArea = document.getElementById('drop-area');
    const fileElem = document.getElementById('fileElem');
    const fileListTableBody = document.getElementById('file-list-table').querySelector('tbody');
    const fileListContainer = document.getElementById('file-list-container');
    const uploadButton = document.getElementById('upload-button');
    const uploadSpinner = document.getElementById('upload-spinner');
    const progressBar = document.getElementById('progress-bar');
    const resultsTableBody = document.getElementById('results-table').querySelector('tbody');
    const resultContainer = document.getElementById('result-container');
    const toast = document.getElementById('toast');

    let filesToUpload = [];
    let uploadedImages = [];

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', loadFromLocalStorage);
    dropArea.addEventListener('click', () => fileElem.click());
    fileElem.addEventListener('change', (e) => handleFileSelection(e.target.files));
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        document.body.addEventListener(eventName, preventDefaults);
        dropArea.addEventListener(eventName, preventDefaults);
    });
    ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight')));
    ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight')));
    dropArea.addEventListener('drop', handleDrop);
    document.getElementById('uploadForm').addEventListener('submit', handleUpload);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function handleDrop(e) {
        handleFileSelection(e.dataTransfer.files);
    }

    function handleFileSelection(files) {
        const newFiles = [...files].filter(file => file.type.startsWith('image/') || file.type.startsWith('video/'));
        if (newFiles.length === 0) return;
        filesToUpload = [...filesToUpload, ...newFiles];
        displayFilesToUpload();
        uploadButton.disabled = false;
    }

    async function displayFilesToUpload() {
        if (filesToUpload.length === 0) {
            fileListContainer.style.display = 'none';
            return;
        }
        fileListContainer.style.display = 'block';
        fileListTableBody.innerHTML = '';

        const filePromises = filesToUpload.map((file, index) => {
            return new Promise(resolve => {
                const row = document.createElement('tr');
                const thumbCell = document.createElement('td');
                const nameCell = document.createElement('td');
                const actionCell = document.createElement('td');

                // Thumbnail
                const img = document.createElement('img');
                img.classList.add('thumbnail');
                img.alt = file.name;
                const reader = new FileReader();
                reader.onload = e => {
                    img.src = e.target.result;
                    thumbCell.appendChild(img);
                    resolve(row);
                };
                reader.readAsDataURL(file);

                // Filename
                nameCell.textContent = file.name;
                nameCell.classList.add('filename');
                nameCell.title = file.name;

                // Remove Button
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.classList.add('secondary', 'outline', 'action-btn');
                removeButton.type = 'button';
                removeButton.onclick = () => removeFile(index);
                actionCell.appendChild(removeButton);

                row.append(thumbCell, nameCell, actionCell);
            });
        });

        const rows = await Promise.all(filePromises);
        rows.forEach(row => fileListTableBody.appendChild(row));
    }

    function removeFile(index) {
        filesToUpload.splice(index, 1);
        displayFilesToUpload();
        uploadButton.disabled = filesToUpload.length === 0;
    }

    async function handleUpload(event) {
        event.preventDefault();
        if (filesToUpload.length === 0) return;

        setLoading(true);
        progressBar.style.display = 'block';
        progressBar.removeAttribute('value'); // Indeterminate progress

        const formData = new FormData();
        filesToUpload.forEach(file => formData.append('file', file));

        try {
            const response = await fetch('/upload', { method: 'POST', body: formData });
            progressBar.setAttribute('value', '100'); // Complete

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Upload failed with status: ${response.status}`);
            }

            const newUploads = await response.json();
            uploadedImages = [...newUploads.filter(item => item.url), ...uploadedImages];
            saveToLocalStorage();
            displayUploadedImages();
            showToast('Upload successful!', 'success');

            // Clear the upload list
            filesToUpload = [];
            displayFilesToUpload();
            uploadButton.disabled = true;

        } catch (error) {
            console.error('Upload error:', error);
            showToast(`Upload failed: ${error.message}`, 'error');
        } finally {
            setLoading(false);
            setTimeout(() => progressBar.style.display = 'none', 500);
        }
    }

    function displayUploadedImages() {
        if (uploadedImages.length === 0) {
            resultContainer.style.display = 'none';
            return;
        }
        resultContainer.style.display = 'block';
        resultsTableBody.innerHTML = '';

        uploadedImages.forEach(item => {
            const row = resultsTableBody.insertRow();
            row.id = `result-${item.id}`;

            // Preview
            const previewCell = row.insertCell();
            const previewLink = document.createElement('a');
            previewLink.href = item.url;
            previewLink.target = '_blank';
            const img = document.createElement('img');
            img.src = item.url;
            img.alt = `Preview of ${item.name}`;
            img.classList.add('thumbnail');
            previewLink.appendChild(img);
            previewCell.appendChild(previewLink);

            // Filename
            const nameCell = row.insertCell();
            nameCell.textContent = item.name;
            nameCell.classList.add('filename');
            nameCell.title = item.name;

            // URL
            const urlCell = row.insertCell();
            const urlLink = document.createElement('a');
            urlLink.href = item.url;
            urlLink.textContent = item.url;
            urlLink.target = '_blank';
            urlCell.appendChild(urlLink);

            // Actions
            const actionsCell = row.insertCell();
            
            // Copy URL Button
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'Copy';
            copyBtn.classList.add('outline', 'action-btn');
            copyBtn.onclick = () => copyToClipboard(item.url, 'URL');
            actionsCell.appendChild(copyBtn);

            // Preview Button
            const previewBtn = document.createElement('button');
            previewBtn.textContent = 'Preview';
            previewBtn.classList.add('outline', 'action-btn');
            previewBtn.onclick = () => window.open(item.url, '_blank');
            actionsCell.appendChild(previewBtn);

            // Delete Button
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.classList.add('contrast', 'outline', 'action-btn');
            deleteBtn.onclick = () => handleDelete(item.id, item.deleteToken);
            actionsCell.appendChild(deleteBtn);
        });
    }

    async function handleDelete(id, token) {
        if (!confirm('Are you sure you want to permanently delete this image?')) return;

        try {
            const response = await fetch(`/api/image/${id}/${token}`, { method: 'DELETE' });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to delete image.');
            }
            
            // Remove from UI and local storage
            document.getElementById(`result-${id}`)?.remove();
            uploadedImages = uploadedImages.filter(img => img.id !== id);
            saveToLocalStorage();
            displayUploadedImages(); // Re-render to hide table if empty
            showToast('Image deleted successfully.', 'success');

        } catch (error) {
            console.error('Delete error:', error);
            showToast(`Error: ${error.message}`, 'error');
        }
    }

    // --- Utility Functions ---
    function setLoading(isLoading) {
        uploadButton.disabled = isLoading;
        uploadSpinner.hidden = !isLoading;
        uploadButton.ariaBusy = isLoading ? 'true' : 'false';
    }

    function copyToClipboard(text, type) {
        navigator.clipboard.writeText(text).then(() => {
            showToast(`${type} copied to clipboard!`, 'success');
        }).catch(err => {
            showToast(`Failed to copy ${type}.`, 'error');
            console.error('Clipboard error:', err);
        });
    }

    let toastTimeout;
    function showToast(message, type = 'success') {
        clearTimeout(toastTimeout);
        toast.textContent = message;
        toast.style.backgroundColor = type === 'error' ? 'var(--pico-color-red-500)' : 'var(--pico-color-green-500)';
        toast.classList.add('show');
        toastTimeout = setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function saveToLocalStorage() {
        try {
            // Only store essential data to avoid large localStorage usage
            const dataToStore = uploadedImages.map(({ id, name, url, deleteToken }) => ({ id, name, url, deleteToken }));
            localStorage.setItem('imger_uploads', JSON.stringify(dataToStore));
        } catch (e) {
            console.warn('Could not save to localStorage:', e);
        }
    }

    function loadFromLocalStorage() {
        try {
            const stored = localStorage.getItem('imger_uploads');
            if (stored) {
                uploadedImages = JSON.parse(stored);
                displayUploadedImages();
            }
        } catch (e) {
            console.warn('Could not load from localStorage:', e);
            localStorage.removeItem('imger_uploads');
        }
    }
</script>
</body>
</html>
